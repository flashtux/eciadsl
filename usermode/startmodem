#!/bin/sh

# Author   : Jean-Sebastien VALETTE <jean-sebastien.valette@libertysurf.fr>
# Creation : 06/12/2001

# 03/02/2002: added a sleep 2 after loading USB controller driver, as suggested
# by Sebastien YAPO <sebastien.yapo@free.fr>.

# 07/02/2002: added the CVS Id
# CVS $Id$
# Tag $Name$

echo "Checking USB system ..."

if [ ! -d /proc/bus/usb ]; then
	/sbin/modprobe usbcore
fi

# mount usbdevfs is this is not the case
if [ ! -f /proc/bus/usb/devices ]; then
	mount -t usbdevfs none /proc/bus/usb
fi

# try to locate UHCI controller
grep -A 4 USB /proc/pci | grep I/O > /dev/null
if [ $? -eq 0 ]; then
	/sbin/modprobe usb-uhci ;
	sleep 2 ;
fi

# try to locate OHCI controller
grep -A 4 USB /proc/pci | grep memory > /dev/null
if [ $? -eq 0 ]; then
	/sbin/modprobe usb-ohci ;
	sleep 2 ;
fi

echo "Init modem ..." ;

# check for the EZ-USB chips. If it's not there, maybe the firmware is 
# already loaded ... so continue.

grep "^P:  Vendor=0547 ProdID=2131" /proc/bus/usb/devices > /dev/null
if [ $? -eq 0 ]; then
	echo "	Load Firmware ..." ;
	/usr/local/bin/eci-load1 /usr/local/bin/eci_firm_kit_wanadoo.bin
	if [ $? -ne 0 ] ; then
		echo "Failed to load firmware" ;
		exit -1 ;
	fi ;
	echo "	... Load Firmware OK"
fi

grep "^P:  Vendor=0915 ProdID=8000" /proc/bus/usb/devices > /dev/null
if [ $? -ne 0 ]; then
	echo "I can't find your modem... sorry :-("
	exit -1;
fi

echo "	Setup modem ..." ;
/usr/local/bin/eci-load2 /usr/local/bin/eci_wan3.bin
if [ $? -ne 0 ] ; then
	echo "Failed to setup the modem" ;
	exit -1 ;
fi ;
echo "	... Setup Modem OK" ;

echo "... modem init OK" ;

echo "Connect Modem ..." ;
nice --20 pppd call adsl updetach
if [ $? -ne 0 ] ; then
	echo "Connexion failed" ;
	exit -1 ;
fi ;
echo "... Connect Modem OK" ;

# The default route should be added automatically if no default route
# already exists. If you already have a default route using your
# ethernet card, you should configure your ethernet card. 

exit 0;

# Wait until ppp0 get available
COUNTER=20
FLREADY="no"
echo "Add Default route ..." ;
echo -n "	wait for ppp0 : " ;
for (( times = 1; times < $COUNTER; times++ )); do
	FOUND=`ifconfig | grep ppp0` ;
	if [ ! -z "$FOUND" ] ; then
		FLREADY="yes" ;
		break ;
	fi ;
	sleep 1 ;
	echo -n "." ;
done

echo "" ;
unset COUNTER ;
unset FOUND ;

if [ "$FLREADY" = "yes" ] ; then
	echo "	ppp0 now available" ;
	route add default dev ppp0 ;
	echo "Default route added" ;
else
	echo "No device found" ;
	unset FLREADY ;
	exit -1 ;
fi ;

unset FLREADY ;

exit 0 ;
