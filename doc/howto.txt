How-to pour le driver Linux du modem ECI USB

1) A qui s'adresse ce document ?

	Ce document s'adresse à tous les possesseurs du modem
	ECI USB voulant l'utiliser sous Linux.

2) Configuration requise

	Assurez vous d'abord vous possédez un noyau Linux 
	de version superieure ou egale a 2.4.7-10

	Distributions où le driver fonctionne : 
		Mandrake Linux 8.1 (noyau 2.4.8-26mk)
		Redhat Linux 7.2 (noyau 2.4.7-10)

	Distributions où le driver ne fonctionne pas :
		Redhat Linux 7.1 (noyau 2.4.2-2)
 
	Cette liste n'est pas exhaustive. Si vous parvenez à vous connecter
	avec un autre distribution ou avec un noyau plus ancien,
	n'hésitez pas a contacter à nous contacter.

3) Procédure d'installation (à ne faire qu'une seule fois)
	Reference : archive usermode.tgz presente sur http://flashcode.free.fr/linux

3.1) Preparation du driver

	Connectez vous en tant que root puis tapez :
	make
	make install

	Il arrive parfois que le modem soit allumé quand vous 
	démarrez votre ordinateur, cela est du au module dabusb,
	il faut l'enlever pour pouvoir installer le driver et faire 
	fonctionner le modem.
	Tapez les commandes suivantes en remplacant VERSION
	par la version de votre noyau Linux : 
	(pour connaite la version du noyau tapez : uname -r)
	
	rm -f /lib/modules/VERSION/dabusb.o.gz
	( ou rm -f /lib/modules/VERSION/dabusb.o selon les distributions)
	depmod -a

	Si vous voulez eviter un reboot :
	- Faite lsmod.
	- Si vous voyez une ligne dabusb : faites rmmod dabusb
	
3.2) Configuration de pppd pour l'ouverture de la connexion

3.2.1) Script /etc/ppp/peers/adsl :

	Il vient avec l'archive usermode.tgz et se place avec le make install
	Il doit ressembler a ca :

	# 12/04/2001 Benoit PAPILLAULT <benoit.papillault@free.fr>
	# 08/05/2001 Updated. Added "novj" & removed "kdebug 7"
	#
	# This file could be rename but its place is under /etc/ppp/peers
	# To connect to Internet using this configuration file
	# pppd call adsl, where "adsl" stands for the name of this file

	debug
	kdebug 1
	noipdefault
	defaultroute
	pty "/usr/local/bin/pppoeci -vpi 8 -vci 35"
	sync
	user "adsl@adsl"
	noaccomp
	nopcomp
	noccp
	novj
	holdoff 1
	maxfail 0
	usepeerdns
	noauth
	#lcp-echo-interval 600
	#lcp-echo-failure 10

	A FAIRE :
	=========

	- si vous etes abonne wanadoo :
	remplacer :
		user "adsl@adsl"
	par :
		user "fti/votre_login@fti"

	- si vous etes abonne club-internet :
	remplacer :
		user "adsl@adsl"
	par :
		user "votre_login@clubadsl1"

	ASTUCE sur certaines machines Linux :
		Si vos premieres connexions echoues, voyez dans /var/log/messages
		Si pppd s'arrete sur un message contenant LCP, alors faites cela :
		dans /etc/ppp/peers/adsl :
		DE-commentez les 2 dernières lignes parlant de LCP.

3.2.2) Script d'authentification pppd

	Votre password sera stocke dans un script d'authentification
	qui depend de l'operateur internet que vous utilisez :

	Pour wanadoo :		/etc/ppp/chap-secrets
	Pour club-internet :	/etc/ppp/pap-secrets

	Les 2 scripts ont exactement la meme syntaxe.
	Vous devez creer un ligne comme suit :

	Pour wanadoo :
		fti/votre_login@fti * votre_password *

	Pour club-internet :
		votre_login@clubadsl1 * votre_password *

	ATTENTION :
	- les "*" sont importants.
	- le premier champ de la ligne DOIT etre egal
	  au contenu de la ligne user du fichier /etc/ppp/peers/adsl

4) Procédure de connexion

4.1) Manuelle (à reproduire à chaque connexion Internet)

3 possibilites de connexions suivant votre distribution ou votre hardware :

	Toute distribution et sur Chipset VIA ou INTEL :
		rmmod usb-uhci
		modprobe usb-uhci
		mount -t usbdevfs none /proc/bus/usb
		startmodem>log

	Pour une CM equipee d'un chip ALI Aladin :
		meme procedure que ci-dessus mais remplacer
		les references a usb-uhci par usb-ohci

	Si vous avez la Linux Mandrake 8.1, la procedure suivante peut s'appliquer
		/etc/rc.d/init.d/usb restart
		startmodem >log

		IMPORTANT (cas particulier sur Mandrake) :
		Modification obligatoire du startmodem avec Mandrake :
		remplacez la ligne :
			ppp call adsl
		par :
			pppd call adsl

CA NE MARCHE PAS :
	Si vous ne surfez pas apres l'une de ces 3 procedures, voir chapitre 5)

4.2) Automatique au demarrage de Linux
	A venir avec les futures versions du driver.
	Inutile tant que le driver est en Beta.

4.3) Reprise automatique sur coupure
        A venir avec les futures versions du driver.
        Inutile tant que le driver est en Beta.

5) problemes connus et solutions

	A remplir : cela depend de tout le monde :
	decrivez vos problemes et les solutions
	que vous avez trouve sur la ML eci@ml.free.fr
	Nous les incorporerons ICI.

5.1) La connexion PPP se fait bien, je vois ppp0 dans ifconfig, mais je ne vais pas sur Internet

	Action 1 :
		verifier que vos DNS sont reconnus :
		dans /etc/resolv.conf
		2 lignes sont presentes commencant par nameserver

		A ce jour :
		
		Chez wanadoo :
		nameserver 193.252.019.3
		nameserver 193.252.019.4

		Chez club-internet :
		nameserver 194.117.200.15
		nameserver 194.117.200.10

		Si ce n'est pas le cas, creer ces 2 lignes dans le fichier.
	
	Action 2 :
		faire : nslookup www.wanadoo.fr
		si pas de reponse et que ppp0 est toujours la dans ifconfig :
		Vous avez surement un probleme de routage :
		faire route -n, cela devrait donner une sortie du genre :
		
		Destination     Passerelle      Genmask         Indic Metric Ref    Use Iface
		127.0.0.0       0.0.0.0         255.0.0.0       U     0      0        0 lo
		0.0.0.0         212.194.0.1     0.0.0.0         UG    0      0        0 ppp0

		La derniere ligne est importante, c'est la GATEWAY par defaut qui vous fais sortir
		sur Internet...

		Si elle n'y est pas, pas de net, donc vous faite sur le shell:
		route add default dev ppp0

		Et ca devrait marcher.

5.2) pppd s'arrete sur erreur : LCP timeout

	Cas 1 : vous avez un probleme de timeout sur la connexion PPP :
	
		Editez /etc/ppp/peers/adsl
	
		DE-Commentez les 2 dernieres lignes :
	
        	lcp-echo-interval 600
	        lcp-echo-failure 10

	Cas 2 : vous avez un probleme d'authentification (PPP ne le dit pas toujours explicitement)

		Corrigez vos scripts :
			/etc/ppp/peers/adsl
			et
			/etc/ppp/chap-secrets (wanadoo) ou /etc/ppp/pap-secrets (club-internet)

		=> retour aux chapitres : 3.2.1 et 3.2.2
	
5.3) Vous avez ce message d'erreur : Can't find your ECI Telecom USB ADSL Loader

	5.3.1) message d'erreur 
	
	[root@hwi usermode]# ./startmodem
	/proc/bus/usb: No such file or directory
	Can't find your ECI Telecom USB ADSL Loader
	ECI Load 1 : failed!
	/proc/bus/usb: No such file or directory
	Can't find your ECI Telecom USB ADSL WAN Modem
	ECI Load 2 : failed!

	Si vois avez un message qui ressemble a ça, c'est que vous n'avez pas monté le systéme de fichier pour l'usb.
	
	5.3.2) Solution 
	
	mount -t usbdevfs none /proc/bus/usb

5.4) eci-load2 n'arrive pas a avoir la synchronisation // blockage au packet 259
	5.4.1) Problème
	
	Le driver n'arrive pas a avoir la synchronisation, il faut alors le relancer.
	
	5.4.2) Solution
	
	Pour relancer le driver, nous vous conseillons de repartir du début en débranchant et en rebranchant le modem, il faut ensuite refaire :
	./startmodem
	

6) Contacts

	Pour toute question, abonnez-vous à la liste de diffusion de ce projet 
	en envoyant un mail vide à eci-request@ml.free.fr?subject=subscribe
	et postez ensuite vos remarques ou suggestions à eci@ml.free.fr 
  

