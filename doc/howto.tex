% latex for the driver doc
% to compile it:
% make

% 07/02/2002 Benoit PAPILLAULT
% howto add an http link:
% - add the beginning of the document: \usepackage{html}
% - to add a link \htmladdnormallink{text}{URL}

% 15/02/2002 Benoit PAPILLAULT
%   change the name log by log.txt to be easier to send as an attachement
%   to an email. (.txt is automatically recognize).

% CVS $Id$
% Tag $Name$

\documentclass[a4paper,12pt]{article}
\usepackage[francais]{babel}
\usepackage{html}
\usepackage[latin1]{inputenc}
\baselineskip=16pt

\title{\huge{How-to pour le driver Linux du modem ECI USB}}
\author{Bertrand Rougier, Thierry De Baere, Florent Manens, Benoît Papillault}

\begin{document}
\pagenumbering{arabic}
\maketitle
\newpage
\tableofcontents
\newpage


\section{Introduction}

\subsection{A qui s'adresse ce document ?}

Ce document s'adresse à tous les possesseurs du modem ADSL ECI USB
voulant l'utiliser sous Linux. Vous trouverez la dernière version de
ce documents sur le site :
\htmladdnormallink{http://eciadsl.sourceforge.net/}{http://eciadsl.sourceforge.net/},
section Documentation.

\subsection{Conventions}

Lors des exemples de commandes à taper au niveau du shell, les
commandes à exécuter en tant qu'utilisateur normal sont précédées de \$
et les commandes à exécuter en root sont précédées de \#.

\section{Configuration requise}

%    Assurez vous d'abord que vous possédez un noyau Linux 
%    de version supérieure ou égale à 2.4.7-10

\subsection{Distributions}

    Distributions où le driver fonctionne : 
    \begin{itemize}
    \item   Mandrake Linux 8.1 (noyau 2.4.8-26mk)
    \item   Redhat Linux 7.2 (noyau 2.4.7-10)
    \end{itemize}
    
    Distributions où le driver ne fonctionne pas :
    \begin{itemize}
    \item   Redhat Linux 7.1 (noyau 2.4.2-2)
    \end{itemize}

\subsection{Noyaux}

Pour obtenir la version de votre noyau:
\begin{verbatim}
$ uname -r
\end{verbatim}

    Liste des noyaux testés (en utilisant la version CVS dont le tag est ``release-test'') :

    \begin{itemize}
    \item kernel 2.4.0 : ok [usb-uhci]
    \item kernel 2.4.1 : ok [usb-uhci]
    \item kernel 2.4.2 : ok [usb-uhci]
    \item kernel 2.4.3 : ok [usb-uhci]
    \item kernel 2.4.4 : ok [usb-uhci]
    \item kernel 2.4.5 : ok [usb-uhci]
    \item kernel 2.4.6 : ok [usb-uhci]
    \item kernel 2.4.7 : ok [usb-uhci]
    \item kernel 2.4.8 : ok [usb-uhci]
    \item kernel 2.4.9 : ok [usb-uhci]
    \item kernel 2.4.10 : kernel panic process\_iso [usb-uhci] , ok [uhci]
    \item kernel 2.4.12 : ok [usb-uhci]
    \item kernel 2.4.13 : ok [usb-uhci]
    \item kernel 2.4.14 : ok [usb-uhci]
    \item kernel 2.4.15 : ok [usb-uhci]
    \item kernel 2.4.16 : ok [usb-uhci]
    \item kernel 2.4.17 : ok [usb-uhci]
    \item kernel 2.5.0 : ok [usb-uhci]
    \end{itemize}

D'autres noyaux sont en cours de test.

\subsection{pppd}

Pour obtenir la version de pppd:
\begin{verbatim}
$ pppd -V
\end{verbatim}

Liste des versions testées:
\begin{itemize}
\item pppd 2.4.0
\item pppd 2.4.1
\end{itemize}

    Cette liste n'est pas exhaustive. Si vous parvenez à vous connecter
    avec une autre distribution ou avec un noyau plus ancien,
    n'hésitez pas à nous contacter.

\section {Procédure d'installation (à ne faire qu'une seule fois)}

Référence : archive \textit{usermode-X.Y.tgz} présente sur
\htmladdnormallink{http://eciadsl.sourceforge.net/}{http://eciadsl.sourceforge.net/},
section Downloads.

\subsection{Préparation du driver}

    Connectez vous en tant que root puis tapez :

\begin{verbatim}
$ cd usermode
$ make
# make install
\end{verbatim}

    Il arrive parfois que le modem soit allumé quand vous 
    démarrez votre ordinateur, cela est du au module dabusb,
    il faut l'enlever pour pouvoir installer le driver et faire 
    fonctionner le modem.
    
    Tapez les commandes suivantes en remplaçant VERSION
    par la version de votre noyau Linux : 
    \footnote{(pour connaître la version du noyau tapez : uname -r)}
    
    rm -f /lib/modules/VERSION/kernel/drivers/usb/dabusb.o.gz
    \footnote{( ou rm -f /lib/modules/VERSION/kernel/drivers/usb/dabusb.o selon les distributions)}\\
    depmod -a

    Si vous voulez éviter un redémarrage :
    \begin {itemize}
    \item Faites lsmod.
    \item Si vous voyez une ligne dabusb : faites rmmod dabusb
    \end{itemize}

\subsection{ Configuration de votre noyau (optionnel) }

Si vous voulez utiliser l'option 'persist' de pppd afin que votre
connexion se reconnecte automatiquement, alors, il faut patcher votre
noyau ou utiliser un noyau >= 2.4.18-pre3. Vous trouverez le patch
\textit{n\_hdlc.c.diff} au sein de l'archive des drivers speedtouch :
\htmladdnormallink{http://speedtouch.sourceforge.net/}{http://speedtouch.sourceforge.net/}.
Voici les instructions pour l'utiliser :

\begin{verbatim}
$ cd /usr/src/linux
$ patch -p1 --dry-run < /repertoire des drivers/n_hdlc.c.diff  ( il y a 2 tirets avant dry-run )
\end{verbatim}

Si aucun message d'erreur n'est renvoyé par la commande patch, tapez
ceci pour effectuer le patch du source :

\begin{verbatim}
$ cd /usr/src/linux
$ patch -p1 < /repertoire des drivers/n_hdlc.c.diff
\end{verbatim}

Voila, compilez ensuite ces modules pour votre noyau :

\begin{verbatim}
$ cd /usr/src/linux
$ make menuconfig
     Character devices --->
     [*] Non-standard serial port support
     <M> HDLC line discipline support
     [*]Unix98 PTY support
$ make clean dep modules
# make modules_install (as root)
\end{verbatim}
    
\subsection{Configuration de pppd pour l'ouverture de la connexion}

\subsubsection{Script /etc/ppp/peers/adsl :}
\label{cha:peers}

Il vient avec l'archive \textit{usermode.tgz} et se place avec le make
install. Il doit ressembler à ça :

\begin{verbatim}
# 12/04/2001 Benoit PAPILLAULT <benoit.papillault@free.fr>
# 08/05/2001 Updated. Added "novj" & removed "kdebug 7"
# 07/02/2002 Replace "maxfail 0" by "maxfail 10"
#
# This file could be rename but its place is under /etc/ppp/peers
# To connect to Internet using this configuration file, type
# pppd call adsl, where "adsl" stands for the name of this file

debug
kdebug 1
noipdefault
defaultroute
pty "/usr/local/bin/pppoeci -v 1 -vpi 8 -vci 35"
sync
user "adsl@adsl"
noaccomp
nopcomp
noccp
novj
holdoff 10

# maxfail is the number of times pppd retries to execute pppoeci after
# an error. If you put 0, pppd retries forever, filling up the process table
# and thus, making the computer unusable.
maxfail 10

usepeerdns
noauth
# You may need lcp-echo feature. But that's optionnal.
# lcp-echo-interval 600
# lcp-echo-failure 10

# You may need the following. But only as a workaround
# mtu 1432
\end{verbatim}

\subsubsection{A FAIRE :}
\label{cha:faire}

    \begin{tabular}{ll}
    - si vous êtes abonné wanadoo :&
    remplacer :\\
        & user "\textit{adsl@adsl}"\\
    &par :\\
        &user "\textit{ fti/votre\_login@fti}"\\

    - si vous êtes abonné club-internet :&
    remplacer :\\
        &user "\textit{adsl@adsl}"\\
    &par :\\
        &user "\textit{votre\_login@clubadsl1}"\\
    \end{tabular}
    
    ASTUCE sur certaines machines Linux :
    
        Si vos premières connexions échouent, voyez dans \textit{ /var/log/messages}
        Si pppd s'arrête sur un message contenant LCP, alors faites cela :\\
        dans \textit{ /etc/ppp/peers/adsl :}
        DE-commentez les 2 dernières lignes parlant de LCP.

\subsubsection{Script d'authentification pppd}

    Votre mot de passe sera stocké dans un script d'authentification
    qui dépend de l'opérateur internet que vous utilisez :
    
    
    \begin{tabular}{ll}
      Pour wanadoo :&     \textit{ /etc/ppp/chap-secrets}\\
      Pour club-internet :&   \textit{ /etc/ppp/pap-secrets}\\
    \end{tabular}
    
    
    Les 2 scripts ont exactement la même syntaxe.
    Vous devez créer un ligne comme suit :
    
    
    \begin{tabular}{ll}
Pour wanadoo       :& \textit{ fti/votre\_login@fti * votre\_password *}\\
Pour club-internet :& \textit{ votre\_login@clubadsl1 * votre\_password *}\\
    \end{tabular}
    
    
    ATTENTION :\\
    - les "*" sont importants.\\
    - le premier champ de la ligne DOIT être égal
      au contenu de la ligne user du fichier \textit{ /etc/ppp/peers/adsl}

\section{Procédure de connexion}

\subsection{Manuelle (à reproduire à chaque connexion Internet)}

C'est très simple, le script startmodem s'occupe de tout ou presque:

\begin{verbatim}
$ /usr/local/bin/startmodem | tee log.txt
\end{verbatim}

ÇA NE MARCHE PAS : Si vous ne surfez pas après l'une de ces 3
procédures, voir chapitre \ref{cha:problemes}.

\subsection{Automatique au démarrage de Linux}

A venir avec les futures versions du driver.  Inutile tant que le
driver est en Bêta.

\subsection{Reprise automatique sur coupure}

Le driver étant pour l'instant en version bêta, cette partie ne
fonctionne pas de manière stable. Néanmoins, voici la procédure à
suivre. Tout d'abord, assurez vous que le module HDLC n'est pas buggé,
vous pouvez aisément faire cette vérification avec
\textit{eci-doctor.sh}. Ensuite, ajouter l'option \textbf{persist} au
fichier \textit{/etc/ppp/peers/adsl}. Relancer pppd et normalement,
votre connexion devrait être opérationnelle 24h/24.

\section{Problèmes connus et solutions}
\label{cha:problemes}

Le driver est livré avec un utilitaire de diagnostic des erreurs de
configuration les plus courantes. Pour l'utiliser, allez dans le
répertoire \textit{usermode} de l'archive des drivers et lancez
\textit{./eci-doctor.sh}.

\begin{verbatim}
# cd usermode
# ./eci-doctor.sh
\end{verbatim}

Si tout est correct, vous aurez les messages suivants:

\begin{verbatim}
Support for USB is OK
Preliminary USB device filesystem is OK
UHCI support is OK
/dev/ppp is OK
HDLC support is OK
HDLC support is OK (no bug)
/etc/ppp/chap-secrets is OK
PPP connection is OK
Default route over ppp0 is OK
Everything is OK
\end{verbatim}

Avant de contacter la liste de diffusion ou qui que ce soit, lisez ce
qui suit. Sinon, n'oubliez pas de joindre le fichier \textit{log.txt}
obtenu lors du lancement de startmodem.

A remplir : cela dépend de tout le monde : décrivez vos problèmes et
les solutions que vous avez trouve sur la liste de diffusion
eci@ml.free.fr Nous les incorporerons ICI.

\subsection{La connexion PPP se fait bien, je vois ppp0 dans ifconfig, mais je ne vais pas sur Internet}

    \subsubsection{Action 1 :}
        vérifier que vos DNS sont reconnus :
        dans \textit{/etc/resolv.conf}
        2 lignes sont présentes commençant par nameserver

        A ce jour :
        
%       \begin {tabular}{l} ptete que e v mettre un tableau après ... on verra
        Chez wanadoo :\\
\begin{verbatim}
nameserver 193.252.19.3
nameserver 193.252.19.4
\end{verbatim}

        Chez club-internet :\\
\begin{verbatim}
nameserver 194.117.200.15
nameserver 194.117.200.10
\end{verbatim}

        Si ce n'est pas le cas, créer ces 2 lignes dans le fichier.
    
    \subsubsection{Action 2 :}
        faire : nslookup www.wanadoo.fr
        
        si pas de réponse et que ppp0 est toujours la dans ifconfig :\\
        Vous avez sûrement un problème de routage :\\
        faire route -n, cela devrait donner une sortie du genre :\\
        
        \begin{tabular}{llllllll}
        Destination  &   Passerelle  &    Genmask     &    Indic& Metric& Ref &   Use& Iface\\
        127.0.0.0   &    0.0.0.0    &     255.0.0.0   &    U  &   0  &    0    &    0 &lo\\
        0.0.0.0    &     212.194.0.1  &   0.0.0.0    &     UG  &  0  &    0    &    0 &ppp0\\
        \end{tabular}
        
        La dernière ligne est importante, c'est la GATEWAY par défaut qui vous fais sortir
        sur Internet...

        Si elle n'y est pas, pas de net, donc vous faite sur le shell:
\begin{verbatim}
# route add default dev ppp0
\end{verbatim}

        Et ça devrait marcher.

\subsection{pppd s'arrête sur erreur : LCP timeout}

    Cas 1 : vous avez un problème de timeout sur la connexion PPP :
    
        \textit{Éditez etc/ppp/peers/adsl}
    
        DE-Commentez les 2 dernières lignes :
\begin{verbatim}
lcp-echo-interval 600
lcp-echo-failure 10
\end{verbatim}

    Cas 2 : vous avez un problème d'authentification (PPP ne le dit pas toujours explicitement)

        Corrigez vos scripts :\\
        
            \textit{/etc/ppp/peers/adsl}\\
            et\\
            \textit{/etc/ppp/chap-secrets} (wanadoo) ou \textit{/etc/ppp/pap-secrets} (club-internet)\par

        => retour aux chapitres : \ref{cha:peers} et \ref{cha:faire}
    
\subsection{Vous avez ce message d'erreur : Can't find your ECI Telecom USB ADSL Loader}

    \subsubsection{Message d'erreur }
    \begin{verbatim}
    [root@hwi usermode]# ./startmodem
    /proc/bus/usb: No such file or directory
    Can't find your ECI Telecom USB ADSL Loader
    ECI Load 1 : failed!
    /proc/bus/usb: No such file or directory
    Can't find your ECI Telecom USB ADSL WAN Modem
    ECI Load 2 : failed!
    \end{verbatim}
    
    Si vois avez un message qui ressemble a ça, c'est que vous n'avez pas monté le système de fichier pour l'usb.
    
    \subsubsection{Solution }
    
\begin{verbatim}
# mount -t usbdevfs none /proc/bus/usb
\end{verbatim}

\subsection{eci-load2 n'arrive pas a avoir la synchronisation // blocage au paquet 259}
    \subsubsection{Problème}
    
    Le driver n'arrive pas a avoir la synchronisation, il faut alors
    le relancer.
    
    \subsubsection{Solution}
    
    Pour relancer le driver, nous vous conseillons de repartir du
    début en débranchant et en rebranchant le modem, il faut ensuite
    refaire : \textit{./startmodem}
    
\subsection{Passer la patate (Debian patato) en noyau 2.4}

C'est vrai que c'est un peu hors sujet mais ça peut aider ceux qui
veulent tester le driver. Vous trouverez la documentation pour faire
ceci a ces adresses :
    
\htmladdnormallink{http://www.fs.tum.de/~bunk/kernel-24.html}{http://www.fs.tum.de/~bunk/kernel-24.html}

Bonne mise à jour!

\section{Contacts}
\subsection{Liste de diffusion}

Pour toute question, abonnez vous à la liste de diffusion de ce projet
en envoyant un mail vide à
\htmladdnormallink{\textbf{eci-request@ml.free.fr}}{mailto:eci-request@ml.free.fr?subject=subscribe}
avec comme sujet \textbf{subscribe} et postez ensuite vos remarques ou
suggestions à
\htmladdnormallink{\textbf{eci@ml.free.fr}}{mailto:eci@ml.free.fr}.

\subsection{IRC}

Vous pouvez vous connecter sur le réseau
\htmladdnormallink{OpenProjects.Net}{http://www.openprojects.net/} sur
le channel \textbf{\#eci} en utilisant le serveur
\htmladdnormallink{\textbf{irc.openprojects.net}}{irc://irc.openprojects.net/eci}
par exemple.
  
\end{document}
