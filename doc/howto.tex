% latex for the driver doc
% to compile it:
% make

% 27/09/2002 FlashCode <flashcode@flashtux.org>
% update this documentation

% 07/02/2002 Benoit PAPILLAULT
% howto add an http link:
% - add the beginning of the document: \usepackage{html}
% - to add a link \htmladdnormallink{text}{URL}

% 15/02/2002 Benoit PAPILLAULT
%   change the name log by log.txt to be easier to send as an attachement
%   to an email. (.txt is automatically recognize).

% CVS $Id$
% Tag $Name$

\documentclass[a4paper,12pt]{article}
\usepackage[francais]{babel}
\usepackage{html}
\usepackage[latin1]{inputenc}
\baselineskip=16pt

\title{\huge{How-to du driver Linux pour modems ECI USB ADSL ou bas\'es sur puce Globespan}}
\author{Bertrand Rougier, Thierry De Baere, Florent Manens, Beno\^{\i}t Papillault, FlashCode}

\begin{document}
\pagenumbering{arabic}
\maketitle
\newpage
\tableofcontents
\newpage


\section{Introduction}

\subsection{A qui s'adresse ce document ?}

Ce document s'adresse \`a tous les possesseurs du modem ADSL ECI USB (ou d'un modem
\'equip\'e d'une puce Globespan) voulant l'utiliser sous Linux.
Vous trouverez la derni\`ere version de ce document sur le site :
\htmladdnormallink{http://eciadsl.flashtux.org}{http://eciadsl.flashtux.org},
section Documentation.

La liste des modems support\'es (ou suppos\'es support\'es) ainsi que la version minimale
du driver pour chaque modem se trouve ici :
\htmladdnormallink{http://eciadsl.flashtux.org/modems.php}{http://eciadsl.flashtux.org/modems.php}

\subsection{Conventions}

Lors des exemples de commandes \`a taper au niveau du shell, les
commandes \`a ex\'ecuter en tant qu'utilisateur normal sont pr\'ec\'ed\'ees de \$
et les commandes \`a ex\'ecuter en root sont pr\'ec\'ed\'ees de \#.

\section{Configuration requise}

%    Assurez vous d'abord que vous poss\'edez un noyau Linux 
%    de version sup\'erieure ou \'egale \`a 2.4.0

\subsection{Distributions}

    Distributions où le driver fonctionne : 
    \begin{itemize}
    \item   Mandrake Linux 8.1 (noyau 2.4.8-26mk)
    \item   Redhat Linux 7.2 (noyau 2.4.7-10)
    \item   Debian 2.2 ou sup\'erieure (noyau 2.4.0 mimimun)
    \item   Slackware
    \item   etc...
    \end{itemize}
    
    Distributions où le driver ne fonctionne pas :
    \begin{itemize}
    \item   Redhat Linux 7.1 (noyau 2.4.2-2)
    \end{itemize}
    
    Le driver est en cours de portage vers *Bsd et MacOs X.\\
    Contacter les \htmladdnormallink{d\'eveloppeurs}{http://eciadsl.flashtux.org/support.php}
    pour en savoir plus sur l'avancement de ces travaux.

\subsection{Noyaux}

Pour obtenir la version de votre noyau:
\begin{verbatim}
$ uname -r
\end{verbatim}

    Liste des noyaux test\'es :

    \begin{itemize}
    \item kernel 2.4.0 : ok [usb-uhci]
    \item kernel 2.4.1 : ok [usb-uhci]
    \item kernel 2.4.2 : ok [usb-uhci]
    \item kernel 2.4.3 : ok [usb-uhci]
    \item kernel 2.4.4 : ok [usb-uhci]
    \item kernel 2.4.5 : ok [usb-uhci]
    \item kernel 2.4.6 : ok [usb-uhci]
    \item kernel 2.4.7 : ok [usb-uhci]
    \item kernel 2.4.8 : ok [usb-uhci]
    \item kernel 2.4.9 : ok [usb-uhci]
    \item kernel 2.4.10 : kernel panic process\_iso [usb-uhci] , ok [uhci]
    \item kernel 2.4.12 : ok [usb-uhci]
    \item kernel 2.4.13 : ok [usb-uhci]
    \item kernel 2.4.14 : ok [usb-uhci]
    \item kernel 2.4.15 : ok [usb-uhci]
    \item kernel 2.4.16 : ok [usb-uhci]
    \item kernel 2.4.17 : ok [usb-uhci]
    \item kernel 2.4.18 : ok [usb-uhci]
    \item kernel 2.4.19 : ok [usb-uhci]
    \item kernel 2.5.0 : ok [usb-uhci]
    \end{itemize}

D'autres noyaux sont en cours de test.

\subsection{pppd}

Pour obtenir la version de pppd:
\begin{verbatim}
$ pppd --version
\end{verbatim}

Liste des versions test\'ees:
\begin{itemize}
\item pppd 2.4.0
\item pppd 2.4.1
\end{itemize}

    Cette liste n'est pas exhaustive. Si vous parvenez \`a vous connecter
    avec une autre distribution ou avec un noyau plus ancien,
    n'h\'esitez pas \`a nous contacter.

\section {Proc\'edure d'installation (\`a ne faire qu'une seule fois)}

R\'ef\'erence : archive \textit{usermode-X.Y.tgz} pr\'esente sur
\htmladdnormallink{http://eciadsl.flashtux.org}{http://eciadsl.flashtux.org},
section T\'el\'echargement.

\subsection{Pr\'eparation du driver}

    Connectez vous en tant que root puis tapez :

\begin{verbatim}
$ cd usermode
$ make
# make install
# eciconf.sh     (ou eciconftxt.sh)
\end{verbatim}

    NB: eciconf.sh est un utilitaire de configuration graphique du driver.
    Il doit par cons\'equent \^etre lanc\'e sous X-window et n\'ecessite la pr\'esence
    des librairies Tcl/Tk.
    
    Si vous n'avez pas X ou Tcl/Tk installé, vous pouvez lancer eciconftxt.sh
    (meme outil qu'eciconf.sh mais en mode texte pour console / terminal).

    Il arrive parfois que le modem soit allum\'e quand vous 
    d\'emarrez votre ordinateur, cela est dû au module dabusb,
    il faut l'enlever pour pouvoir installer le driver et faire 
    fonctionner le modem.
    
    3 possibilit\'es pour enlever ce module :
    
    \textbf{1)} Par eciconf.sh : d\'ebranchez votre modem puis dans eciconf.sh cliquez
    sur "Remove dabusb module".
    
    \textbf{2)} Par eciconftxt.sh : choix 2, puis suivez les instructions.
    
    \textbf{3)} Tapez les commandes suivantes en remplaçant VERSION par la version de
    votre noyau Linux : 
    \footnote{(pour conna\^{\i}tre la version du noyau tapez : uname -r)}
    
    rm -f /lib/modules/VERSION/kernel/drivers/usb/dabusb.o.gz
    \footnote{( ou rm -f /lib/modules/VERSION/kernel/drivers/usb/dabusb.o selon les distributions)}\\
    depmod -a

    Si vous voulez \'eviter un red\'emarrage :
    \begin {itemize}
    \item Faites lsmod.
    \item Si vous voyez une ligne dabusb : faites rmmod dabusb
    \end{itemize}

\subsection{ Configuration de votre noyau (optionnel) }

Si vous voulez utiliser l'option 'persist' de pppd afin que votre
connexion se reconnecte automatiquement, alors il faut patcher votre
noyau ou utiliser un noyau >= 2.4.18-pre3. Vous trouverez le patch
\textit{n\_hdlc.c.diff} au sein de l'archive des drivers Speedtouch :
\htmladdnormallink{http://speedtouch.sourceforge.net/}{http://speedtouch.sourceforge.net/}.
Voici les instructions pour l'utiliser :

\begin{verbatim}
$ cd /usr/src/linux
$ patch -p1 --dry-run < /r\'epertoire des drivers/n_hdlc.c.diff  ( il y a 2 tirets avant dry-run )
\end{verbatim}

Si aucun message d'erreur n'est renvoy\'e par la commande patch, tapez
ceci pour effectuer le patch du source :

\begin{verbatim}
$ cd /usr/src/linux
$ patch -p1 < /r\'epertoire des drivers/n_hdlc.c.diff
\end{verbatim}

Voila, compilez ensuite ces modules pour votre noyau :

\begin{verbatim}
$ cd /usr/src/linux
$ make menuconfig
     Character devices --->
     [*] Non-standard serial port support
     <M> HDLC line discipline support
     [*]Unix98 PTY support
$ make clean dep modules
# make modules_install (as root)
\end{verbatim}
    
\subsection{Configuration de pppd pour l'ouverture de la connexion}

Si vous avez utilis\'e eciconf.sh, vous pouvez aller directement \`a la section 4.

\subsubsection{Script /etc/ppp/peers/adsl :}
\label{cha:peers}

Il vient avec l'archive \textit{usermode-X.Y.tgz} et se place avec le make
install. Il doit ressembler \`a ça :

\begin{verbatim}
# 12/04/2001 Benoit PAPILLAULT <benoit.papillault@free.fr>
# 08/05/2001 Updated. Added "novj" & removed "kdebug 7"
# 07/02/2002 Replace "maxfail 0" by "maxfail 10"
# 29/04/2002 Added the option "linkname" to easily locate the running pppd
#
# This file could be rename but its place is under /etc/ppp/peers
# To connect to Internet using this configuration file, type
# pppd call adsl, where "adsl" stands for the name of this file

debug
kdebug 1
noipdefault
defaultroute
pty "/usr/local/bin/pppoeci -v 1 -vpi 8 -vci 35 -vendor 0x0915 -product 0x8000"
sync
user "adsl@adsl"
noaccomp
nopcomp
noccp
novj
holdoff 10

# This will store the pid of pppd in the first line of /var/run/ppp-eciadsl.pid
# and the interface created (like ppp0) on the second line.
linkname eciadsl

# maxfail is the number of times pppd retries to execute pppoeci after
# an error. If you put 0, pppd retries forever, filling up the process table
# and thus, making the computer unusable.
maxfail 10

usepeerdns
noauth

# If your PPP peer answer to LCP EchoReq (lcp-echo requests), you can
# use the lcp-echo-failure to detect disconnected links with:
#
# lcp-echo-interval 600
# lcp-echo-failure 10
#
# However, if your PPP peer DOES NOT answer to lcp-echo request, you MUST
# desactivate this feature with the folowing line
#
lcp-echo-interval 0

# You may need the following, but ONLY as a workaround
# mtu 1432
\end{verbatim}

\subsubsection{A FAIRE :}
\label{cha:faire}

    \begin{tabular}{ll}
    - si vous \^etes abonn\'e wanadoo :&
    remplacer :\\
        & user "\textit{adsl@adsl}"\\
    &par :\\
        &user "\textit{ fti/votre\_login@fti}"\\

    - si vous \^etes abonn\'e club-internet :&
    remplacer :\\
        &user "\textit{adsl@adsl}"\\
    &par :\\
        &user "\textit{votre\_login@clubadsl1}"\\
    \end{tabular}
    
    ASTUCE sur certaines machines Linux :
    
        Si vos premi\`eres connexions \'echouent, voyez dans \textit{ /var/log/messages}
        Si pppd s'arr\^ete sur un message contenant LCP, alors faites cela :\\
        dans \textit{ /etc/ppp/peers/adsl :}
        DE-commentez les 2 derni\`eres lignes parlant de LCP.

\subsubsection{Script d'authentification pppd}

    Votre mot de passe sera stock\'e dans un script d'authentification
    qui d\'epend de l'op\'erateur internet que vous utilisez :
    
    
    \begin{tabular}{ll}
      Pour wanadoo :&     \textit{ /etc/ppp/chap-secrets}\\
      Pour club-internet :&   \textit{ /etc/ppp/pap-secrets}\\
    \end{tabular}
    
    
    Les 2 scripts ont exactement la m\^eme syntaxe.
    Vous devez cr\'eer une ligne comme suit :
    
    
    \begin{tabular}{ll}
Pour wanadoo       :& \textit{ fti/votre\_login@fti * votre\_password *}\\
Pour club-internet :& \textit{ votre\_login@clubadsl1 * votre\_password *}\\
    \end{tabular}
    
    
    ATTENTION :\\
    - les "*" sont importants.\\
    - le premier champ de la ligne DOIT \^etre \'egal
      au contenu de la ligne user du fichier \textit{ /etc/ppp/peers/adsl}

\section{Proc\'edure de connexion}

\subsection{Manuelle (\`a reproduire \`a chaque connexion Internet)}

C'est tr\`es simple, le script startmodem s'occupe de tout ou presque:

\begin{verbatim}
$ /usr/local/bin/startmodem | tee log.txt
\end{verbatim}

ÇA NE MARCHE PAS : Si vous ne surfez pas apr\`es l'une de ces 3
proc\'edures, voir chapitre \ref{cha:problemes}.

\subsection{Automatique au d\'emarrage de Linux}

A venir avec les futures versions du driver.  Inutile tant que le
driver est en B\^eta.

\subsection{Reprise automatique sur coupure}

Le driver \'etant pour l'instant en version b\^eta, cette partie ne
fonctionne pas de mani\`ere stable. N\'eanmoins, voici la proc\'edure \`a
suivre. Tout d'abord, assurez vous que le module HDLC n'est pas bugg\'e,
vous pouvez ais\'ement faire cette v\'erification avec
\textit{eci-doctor.sh}. Ensuite, ajouter l'option \textbf{persist} au
fichier \textit{/etc/ppp/peers/adsl}. Relancer pppd et normalement,
votre connexion devrait \^etre op\'erationnelle 24h/24.

\section{Probl\`emes connus et solutions}
\label{cha:problemes}

Le driver est livr\'e avec un utilitaire de diagnostic des erreurs de
configuration les plus courantes. Pour l'utiliser, allez dans le
r\'epertoire \textit{usermode} de l'archive des drivers et lancez
\textit{./eci-doctor.sh}.

\begin{verbatim}
# cd usermode
# ./eci-doctor.sh
\end{verbatim}

Si tout est correct, vous aurez les messages suivants:

\begin{verbatim}
Support for USB is OK
Preliminary USB device filesystem is OK
UHCI support is OK
/dev/ppp is OK
HDLC support is OK
HDLC support is OK (no bug)
/etc/ppp/chap-secrets is OK
PPP connection is OK
Default route over ppp0 is OK
Everything is OK
\end{verbatim}

Avant de contacter la liste de diffusion ou qui que ce soit, lisez ce
qui suit. Sinon, n'oubliez pas de joindre le fichier \textit{log.txt}
obtenu lors du lancement de startmodem.

A remplir : cela d\'epend de tout le monde : d\'ecrivez vos probl\`emes et
les solutions que vous avez trouv\'ees sur la liste de diffusion
eci@ml.free.fr Nous les incorporerons ICI.

\subsection{Eci-load2 n'arrive pas a avoir la synchronisation // blocage au paquet 259 (ou autre paquet)}

Il peut arriver que le driver n'arrive pas \`a avoir la synchronisation.
Il faut alors le relancer (nous vous conseillons de repartir du
d\'ebut en d\'ebranchant et en rebranchant le modem, il faut ensuite refaire : \textit{./startmodem})

Par contre si le blocage est syst\'ematiquement sur le m\^eme paquet apr\`es plusieurs tentatives,\\
il faut changer le fichier .bin qui sert \`a synchroniser le modem.
Des fichiers .bin "tout pr\^ets" sont disponibles ici :
\htmladdnormallink{http://eciadsl.flashtux.org/download.php#sync}{http://eciadsl.flashtux.org/download.php#sync}
Si aucun .bin ne fonctionne, vous devez alors cr\'eer votre propre .bin
(voir sur la page ci-dessus la documentation)

Il y a 2 façons de changer le .bin :

    \subsubsection{Façon 1 :}
        Avec une version du driver strictement sup\'erieure \`a 0.5 (CVS ou >= 0.6) :\\
        le changement se fait dans eciconftxt.sh
    
    \subsubsection{Façon 2 :}
        Avec toutes les versions du driver, vous pouvez effectuer ceci :\\
        \'ecraser le fichier /etc/eciadsl/eci_wan3.bin par un autre .bin\\
        
        Exemple :
\begin{verbatim}
cp /mon_chemin/eci_wan3.bordeaux.bin /etc/eciadsl/eci_wan3.bin
\end{verbatim}

\subsection{La connexion PPP se fait bien, je vois ppp0 dans ifconfig, mais je ne vais pas sur Internet}

    \subsubsection{Action 1 :}
        v\'erifier que vos DNS sont reconnus :
        dans \textit{/etc/resolv.conf}
        2 lignes sont pr\'esentes commençant par nameserver

        A ce jour :
        
%       \begin {tabular}{l} ptete que e v mettre un tableau apr\`es ... on verra
        Chez wanadoo :\\
\begin{verbatim}
nameserver 193.252.19.3
nameserver 193.252.19.4
\end{verbatim}

        Chez Club Internet :\\
\begin{verbatim}
nameserver 194.117.200.15
nameserver 194.117.200.10
\end{verbatim}

        Chez 9 Telecom :\\
\begin{verbatim}
nameserver 212.30.96.108
nameserver 213.203.124.146
\end{verbatim}

        Chez Cegetel :\\
\begin{verbatim}
nameserver 194.6.128.3
nameserver 194.6.128.4
\end{verbatim}

        Chez World Online :\\
\begin{verbatim}
nameserver 212.83.128.3
nameserver 212.83.128.4
\end{verbatim}

        Chez Telecom Italia :\\
\begin{verbatim}
nameserver 212.216.112.112
nameserver 212.216.172.62
\end{verbatim}

        Chez Tiscali Italia :\\
\begin{verbatim}
nameserver 195.130.224.18
nameserver 195.130.225.129
\end{verbatim}

        Chez Pipex UK :\\
\begin{verbatim}
nameserver 158.43.240.4
nameserver 158.43.240.3
\end{verbatim}

        Si ce n'est pas le cas, cr\'eer ces 2 lignes dans le fichier.
    
    \subsubsection{Action 2 :}
        faire : nslookup www.wanadoo.fr
        
        si pas de r\'eponse et que ppp0 est toujours la dans ifconfig :\\
        Vous avez sûrement un probl\`eme de routage :\\
        faire route -n, cela devrait donner une sortie du genre :\\
        
        \begin{tabular}{llllllll}
        Destination  &   Passerelle  &    Genmask     &    Indic& Metric& Ref &   Use& Iface\\
        127.0.0.0   &    0.0.0.0    &     255.0.0.0   &    U  &   0  &    0    &    0 &lo\\
        0.0.0.0    &     212.194.0.1  &   0.0.0.0    &     UG  &  0  &    0    &    0 &ppp0\\
        \end{tabular}
        
        La derni\`ere ligne est importante, c'est la GATEWAY par d\'efaut qui vous fais sortir
        sur Internet...

        Si elle n'y est pas, pas de net, donc vous faites sur le shell :
\begin{verbatim}
# route add default dev ppp0
\end{verbatim}

        Et ça devrait marcher.

\subsection{pppd s'arr\^ete sur erreur : LCP timeout}

    Cas 1 : vous avez un probl\`eme de timeout sur la connexion PPP :
    
        \textit{Éditez etc/ppp/peers/adsl}
    
        DE-Commentez les 2 derni\`eres lignes :
\begin{verbatim}
lcp-echo-interval 600
lcp-echo-failure 10
\end{verbatim}

    Cas 2 : vous avez un probl\`eme d'authentification (PPP ne le dit pas toujours explicitement)

        Corrigez vos scripts :\\
        
            \textit{/etc/ppp/peers/adsl}\\
            et\\
            \textit{/etc/ppp/chap-secrets} (wanadoo) ou \textit{/etc/ppp/pap-secrets} (club-internet)\par

        => retour aux chapitres : \ref{cha:peers} et \ref{cha:faire}
    
\subsection{Vous avez ce message d'erreur : Can't find your ECI Telecom USB ADSL Loader}

    \subsubsection{Message d'erreur }
    \begin{verbatim}
    [root@hwi usermode]# ./startmodem
    /proc/bus/usb: No such file or directory
    Can't find your ECI Telecom USB ADSL Loader
    ECI Load 1 : failed!
    /proc/bus/usb: No such file or directory
    Can't find your ECI Telecom USB ADSL WAN Modem
    ECI Load 2 : failed!
    \end{verbatim}
    
    Si vous avez un message qui ressemble a ça, c'est que vous n'avez pas mont\'e le syst\`eme de fichier pour l'usb.
    
    \subsubsection{Solution }
\begin{verbatim}
# mount -t usbdevfs none /proc/bus/usb
\end{verbatim}

\subsection{Messages "Timeout USB" une fois connect\'e}

    Ajoutez l'option "mtu 1432" dans votre script /etc/ppp/peers/adsl

\section{Contacts}

\subsection{Support}

Tous les moyens de faire appel au support sont ici :
\htmladdnormallink{http://eciadsl.flashtux.org/support.php}{http://eciadsl.flashtux.org/support.php}

\subsection{Liste de diffusion}

Pour toute question, abonnez vous \`a la liste de diffusion de ce projet
en envoyant un mail vide \`a
\htmladdnormallink{\textbf{eci-request@ml.free.fr}}{mailto:eci-request@ml.free.fr?subject=subscribe}
avec comme sujet \textbf{subscribe} et postez ensuite vos remarques ou
suggestions \`a
\htmladdnormallink{\textbf{eci@ml.free.fr}}{mailto:eci@ml.free.fr}.

\subsection{IRC}

Vous pouvez vous connecter sur le r\'eseau
\htmladdnormallink{OpenProjects.Net}{http://www.openprojects.net/} sur
le channel \textbf{\#eci} en utilisant le serveur
\htmladdnormallink{\textbf{irc.openprojects.net}}{irc://irc.openprojects.net/eci}
par exemple.
  
\end{document}
